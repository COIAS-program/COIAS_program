# COIAS.py の使い方

## COIAS.py 実行直後に現れる第一画面について

- 「image preference」ラジオボタンにて、マスクあり画像を表示させるか(mask) マスクなし画像を表示させるか(nonmask) 選ぶことができる。
- 「COIAS mode」ラジオボタンにて、どのモードで起動するか選べる。
  - searchモードでは自動検出した移動天体候補から本物の移動天体を目視で選別する。ほとんどの移動天体候補はノイズである。
  - manual measureモードでは自動検出できなかった移動天体を手動クリックで選び、手動で四角アパーチャーを設定する。
  - reconfirm/name modifyモードではsearchモードとmanual measureモードで選んだ移動天体が本物かどうか目視で確認する。また新天体の名前を任意に付け替えることもできる。
  - final checkモードでは最終的に出力されたsend_mpc.txtの内容をGUIで視認することができる。
- ラジオボタンを選択したのち、「Load img」ボタンでメイン画面が開く。
- 「Quit」ボタンで画面を閉じれるが、画面隅の赤いバツ印(Mac)を押して閉じることと同じである。

## メイン画面のモード間共通の操作とボタンについて
- 画像は画面右と下にあるスクロールバーをドラッグすることでスクロール可能。グラブやマウスホイールによるスクロールには非対応。拡大縮小にも非対応。
- 以下ボタンを左上から順に説明する
  - 「Blink start/stop」ボタンでブリンクの開始・停止ができる。キーボードの「sキー」を押しても同じことができる。
  - 「Back」ボタンで一枚前に戻る。キーボードの「左キー」を押しても同じことができる。
  - 「Next」ボタンで一枚次に移る。キーボードの「右キー」を押しても同じことができる。
  - 「Sq. Off/On」ボタンで移動天体候補を囲む四角とその名前を表示/非表示にできる。四角が邪魔になって光源が見づらい時に使う。
  - その右隣のメッセージボックスには画像番号が表示される。
  - その右隣のメッセージボックスにはマウスカーソルのピクセル座標が表示される。
  - その右隣のメッセージボックスにはその他のメッセージが表示される。
  - 今回測定する画像の日付から2日以内の観測日の測定を過去に行っていた場合, それら過去の新天体の測定データからそれら新天体が今回の画像のどこに存在するか予測して表示する. そのような予測は緑の円で表示され, 天体の名前は円の右下に「pre: H〇〇〇〇〇〇」と表示される. その予測点に実際に新天体があった場合, 測定の後にname modifyモードで予測に示される名前と一致させるように修正することで, 2日以上の観測アークでMPCに新天体報告を行うことができる.
  - 過去に行われた測定の中に今回測定する画像の測定があった場合, それも画面に表示される. そのような天体はピンクの円で表示され, 過去の測定における天体の名前が円の右下に「done: H〇〇〇〇〇〇」と表示される. そのような天体は重複報告となるため, 基本的にレポートモードで弾かれる.

## searchモードでの操作について
- searchモードでは自動検出された移動天体候補から、本物の移動天体とノイズを選別する作業を行う。
- 本物の移動天体はある程度一定の見た目の点光源が直線上に一定の速度で移動するが、ノイズは見た目が極めてあいまいだったりその場をふらついていたりする。
- Hから始まる7桁の番号がついているのが移動天体候補。本物の移動天体だと思うものの四角をクリックしてその四角を赤くする。
- 間違った移動天体候補をクリックして赤くしてしまっても、もう一度クリックすれば黒くして未選択な状態に戻せる。
- 「Hから始まる7桁の番号」以外の天体は既知天体。既知天体は自動的に報告されるので選択は不要で、それらの四角をクリックしても何も起こらず、メッセージ欄にその旨が表示される。
- 一通り本物の移動天体を選び終えたら、右上の「Output」ボタンを押して、選択した天体の情報のみをmemo.txtに書き出す。
- ちなみにオートセーブに対応していて、画面をクリックするごとにmemo.txtに出力されるので途中でクラッシュしても安心。manual measureモードでも同じくmemo_manual.txtにオートセーブされる。

## manual measureモードでの操作について
- まずmanual measureモードは、searchモードで移動天体のみを出力したのち Astsearch_between_COIAS_and_ReCOIAS [新天体の通し番号] をターミナルで実行してからでないと実施できない。
- ただしmanual measureモードそのものを飛ばすことは可能。明らかに手動測定できる天体がない時は、Astsearch_between_COIAS_and_ReCOIAS を実行後にreconfirm/name modifyモードに行っても良い。
- manual measureモードではsearchモードで選ばなかったノイズは表示されない。searchモードで選んだ移動天体も番号が連番で付け替えられたH番号になり、黒い四角で表示される。
- manual measureモードでは自動検出できなかった移動天体を手動で選ぶ。ここでは移動天体だと思うものをクリックする。
- H番号を自動で振って欲しい時は「Output」ボタンの左隣にある「Manual H Number:」を「Auto」にしておく。Autoモードではクリック後にその天体が直前に選んだ天体と同じかどうか聞かれるので、新規天体なら「No」を、直前に選んだ天体に追加したいなら「Yes」を選ぶ。「No」なら新しいH番号が振られ、「Yes」なら直前に選んだ天体と同じ番号が振られる。
- ある移動天体にH番号を振ってから他の天体の測定に行き、また戻って再び以前の移動天体に追加したい時など、特定のH番号を手動で設定したい場合は、「Manual H Number:」ボタンをクリックして「Self」にしておく。Selfモードではクリック後にその天体のH番号を入力するダイアログが開くので、設定したい番号を打ち込む。
- ダイアログの選択ボタンを押すと、クリックしたピクセル周辺の拡大画像が別ウィンドウで表示される。拡大した移動天体を長方形で囲むために、長方形の頂点のうち3点を選ぶように3点をクリックする。詳しい長方形の設置方法は拡大画像ウィンドウ右上の「Help」ボタンを押すと見れる。
- 設置した点や長方形が気に食わなければいつでも右下の「Clear」ボタンで消去できる。設置した長方形が良ければ左下の「Yes」ボタンをクリックする。この天体の長方形の設置そのものを取りやめたければ拡大画像ウィンドウ隅の赤いバツ印(Mac)で画面を閉じる。
- 「Yes」ボタンをクリックすると拡大画像ウィンドウが閉じられ、元のメイン画面で選択した天体が青い四角で囲まれる。
- 別の画像で同じ移動天体だと思うものがあれば、画像をブリンクさせ別の画像で同じ天体に同じ番号が付くように同様の作業を行う。
- 間違って青い四角を設置してしまった場合は、青い四角をクリックして聞かれるダイアログで「Yes」を押すと消去できる。
- またこのモードでは自動検出天体でノイズを巻き込んでしまっているものを測定ごとに排除できる(例: 1枚目と3枚目の画像のノイズと7-12枚目の画像のシグナルをまとめて1つの天体と認識している場合、1と3枚目の画像のノイズだけを削除する)。このモードで黒色の四角で表示されている自動検出天体をクリックすると、「消しますか?」とダイアログで聞かれるので、Yesをクリックするとその天体を排除すると見なし灰色の四角で表示されるようになる。灰色の四角をもう一度クリックすると「元に戻しますか?」とダイアログで聞かれるので、Yesをクリックすると元の黒色の四角に戻すことができる。灰色の四角の測定点は manual_delete_list.txt に書き出され、後にデータから排除される。
- 一通り選んだあとに、メイン画面右上の「Output」ボタンを押し memo_manual.txt と manual_delete_list.txt を出力する。
- その後ターミナルにて AstsearchR_after_manual を必ず実行すること。

## reconfirm/name modifyモードでの操作について
- searchモードおよびAstsearch_between_COIAS_and_ReCOIASを実行したあと、もしくはmanual measureモードおよびAstsearchR_after_manualを実行した後に実施できる。
- 両モードで移動天体だと指定した天体の四角のみが表示される。
- reconfirm/name modifyモードではそれらが本当に移動天体かどうか目視で確認をする。
- 自動検出にて1つの移動天体が2つの移動天体として認識されている場合 (例: 1-4枚目ではH000001、5-8枚目ではH000002) や、1つの移動天体なのにいくつかの画像で光源検出に失敗する場合がある。検出漏れをした光源を手動測定モードで測定しても別の名前が与えられてしまい、同じ天体とはみなされない。そのような場合に、目視で1つの移動天体とみなせる複数の名前を1つの天体として報告させるため、名前を変更して1つの名前に統一させることがこのモードでは可能である。前出の例では5-8枚目のH000002の名前をH000001に変更してしまえば1つの天体として扱うことができる。
- ただし、既知天体の名前(H......以外の名前)は変更することはできない。
- 変更したい天体名の四角をクリックして、出てくるダイアログのテキストボックス欄に変更後の名前を直接打つ、もしくはそのボックスの右にある下矢印をクリックして出てくるプルダウンリストから変更後の名前を選択して、「OK」ボタンを押す。
- すると、GUI上では変更後の名前が黄色で表示され、四角も黄色で表示される。名前を元に戻したいときは、黄色い四角をクリックして出てくるダイアログで「Yes」を選べば元に戻せる。
- 名前を付け替え終えたら、メイン画面右上の「Output」ボタンを押しmanual_name_modify_list.txtを出力する。このファイルは以前の解析をやり直すと番号付替の不整合を防ぐために消えてしまうので、解析をやり直したら必ずname modifyモードでの番号付け替えを行い「Output」ボタンを押すこと。
- 自信がある人はreconfirm/name modifyモードでの確認も飛ばすことができる。
- 確認後、ターミナルで AstsearchR_afterReCOIAS を実行すれば終了。

## final checkモードでの操作について
- 最終的に出力されるsend_mpc.txtと同一の内容 (final_disp.txt) を表示させるモード。
- 最終結果をGUIで確認したいときに使用する。編集などの操作はできない。